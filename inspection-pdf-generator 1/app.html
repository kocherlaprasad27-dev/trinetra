<!DOCTYPE html>
<html lang="en">

<head>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#473c39">
    <title>Quality Inspection App</title>
    <script src="api.js"></script>
    <script src="login.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #473c39 0%, #6b5d57 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #473c39;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .demo-credentials {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #473c39;
            border-left: 4px solid #d4c4a9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #473c39;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d4a574;
        }

        .btn {
            padding: 14px 30px;
            background: #d4c4a9;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #c49564;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 165, 116, 0.3);
        }

        .btn-full {
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Main App */
        .app-header {
            background: #473c39;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: #d4a574;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: white;
            color: #473c39;
        }

        .tabs {
            background: white;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 18px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn:hover {
            background: #f9f9f9;
        }

        .tab-btn.active {
            background: #473c39;
            color: white;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #d4a574;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #e0e0e0;
        }

        .card-header h2 {
            color: #473c39;
            font-size: 22px;
        }

        .room-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dimension-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .dim-length,
        .dim-width,
        .dim-area {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .dim-length:focus,
        .dim-width:focus {
            border-color: #473c39;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(71, 60, 57, 0.1);
            outline: none;
        }

        .dim-area {
            background-color: #f0f0f0;
            color: #555;
            cursor: not-allowed;
            font-weight: 500;
        }

        .input-small {
            width: 100%;
        }

        .remove-dimension-btn {
            padding: 12px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .remove-dimension-btn:hover {
            background: #c82333;
        }

        .rooms-list {
            margin-top: 30px;
        }

        .room-item {
            background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #d4a574;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .room-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .room-item-header h3 {
            color: #473c39;
            font-size: 20px;
        }


        .dimensions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }

        .dimension-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .dimension-item:hover {
            border-color: #d4a574;
            box-shadow: 0 3px 10px rgba(212, 165, 116, 0.2);
        }

        .dimension-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dimension-item .value {
            color: #473c39;
            font-weight: 700;
            font-size: 18px;
        }

        .dimension-item.total {
            background: linear-gradient(135deg, #d4a574 0%, #c49564 100%);
            color: white;
            border: none;
        }

        .dimension-item.total label {
            color: white;
        }

        .dimension-item.total .value {
            color: white;
        }

        .summary-section {
            background: linear-gradient(135deg, #473c39 0%, #6b5d57 100%);
            color: white;
            padding: 35px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .summary-section h3 {
            margin-bottom: 25px;
            font-size: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-item label {
            display: block;
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-item .value {
            font-size: 32px;
            font-weight: 700;
        }

        /* Quality Check Styles */
        .quality-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .quality-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid #d4a574;
        }

        .quality-card h3 {
            color: #473c39;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 45px;
            border-radius: 25px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            transition: width 0.5s;
        }

        .progress-major {
            background: linear-gradient(90deg, #473c39 0%, #6b5d57 100%);
        }

        .progress-minor {
            background: linear-gradient(90deg, #d4a574 0%, #c49564 100%);
        }

        .progress-cosmetic {
            background: linear-gradient(90deg, #8b7355 0%, #a58968 100%);
        }

        .issue-list {
            margin-top: 30px;
        }

        .issue-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d4a574;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .issue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .issue-item-content {
            display: flex;
            gap: 20px;
            align-items: start;
        }

        .issue-details {
            flex: 1;
        }

        .issue-details h4 {
            color: #473c39;
            margin-bottom: 8px;
        }

        .issue-details p {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .issue-actions {
            display: flex;
            gap: 10px;
        }

        .issue-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-major {
            background: #473c39;
            color: white;
        }

        .badge-minor {
            background: #d4a574;
            color: white;
        }

        .badge-cosmetic {
            background: #8b7355;
            color: white;
        }

        .water-quality-section {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .water-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .param-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .param-card.good {
            border-color: #28a745;
        }

        .param-card label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .param-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }

        .param-card .range {
            font-size: 13px;
            color: #666;
        }

        .image-upload-area {
            border: 3px dashed #d4a574;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .image-upload-area:hover {
            background: #fff;
            border-color: #c49564;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .hidden {
            display: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group .btn {
            flex: 1;
        }

        .quality-status {
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-good {
            color: #28a745;
        }

        .status-warning {
            color: #ffc107;
        }

        .status-bad {
            color: #dc3545;
        }

        .issue-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .issue-images img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
        }

        /* Issue Dropdown Styles */
        .issue-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #d4a574;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .issue-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .issue-dropdown-item:hover {
            background: #f9f9f9;
        }

        .issue-dropdown-item:last-child {
            border-bottom: none;
        }

        .issue-dropdown-item .issue-title {
            font-weight: 600;
            color: #473c39;
            margin-bottom: 3px;
        }

        .issue-dropdown-item .issue-type {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-left: 8px;
        }

        .issue-type-major {
            background: #473c39;
            color: white;
        }

        .issue-type-minor {
            background: #d4a574;
            color: white;
        }

        .issue-type-cosmetic {
            background: #8b7355;
            color: white;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* Brand Check Styles */
        .brand-section {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .brand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .brand-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .brand-card label {
            display: block;
            font-size: 14px;
            color: #473c39;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .brand-card select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
        }

        .brand-card select:focus {
            outline: none;
            border-color: #d4a574;
        }

        /* Checklist Styles */
        .checklist-section {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .checklist-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d4a574;
        }

        .checklist-item p {
            color: #473c39;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .checklist-item label {
            display: block;
            margin: 8px 0;
            color: #666;
            cursor: pointer;
        }

        .checklist-item input[type="radio"] {
            margin-right: 8px;
        }

        /* Room-specific sections */
        .room-specific-section {
            background: #f0f0f0;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #d4a574;
        }

        .room-specific-section h4 {
            color: #473c39;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .material-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .material-card label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .material-card select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        .login-header img {
            width: 120px;
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .login-box {
                padding: 30px 20px;
                max-width: 400px;
            }

            .login-header h1 {
                font-size: 24px;
            }

            .dimension-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }

            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }

            .app-header h1 {
                font-size: 20px;
            }

            .tab-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .tab-btn {
                padding: 15px;
                font-size: 14px;
            }

            .card {
                padding: 20px;
            }

            .card-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .room-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .dimensions-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
            }

            .dimension-item {
                padding: 12px;
            }

            .dimension-item .value {
                font-size: 16px;
            }

            .summary-section {
                padding: 25px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .summary-item .value {
                font-size: 24px;
            }

            .issue-item-content {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .material-card {
                padding: 15px;
            }

            .quality-grid {
                grid-template-columns: 1fr;
            }

            .inspection-grid {
                grid-template-columns: 1fr;
            }

            .inspection-item img {
                max-width: 100%;
                height: auto;
            }

            .issue-images img {
                width: 60px;
                height: 60px;
            }
        }

        /* Tablet styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }

            .login-box {
                max-width: 500px;
                width: 100%;
            }

            .app-header h1 {
                font-size: 22px;
            }

            .tab-btn {
                padding: 16px;
                font-size: 15px;
            }

            .dimensions-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .room-form {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Large desktop styles */
        @media (min-width: 1200px) {
            .container {
                max-width: 1600px;
            }

            .app-header h1 {
                font-size: 28px;
            }

            .tab-btn {
                padding: 20px;
                font-size: 17px;
            }

            .dimensions-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Premium Loader */
        .pdf-loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            transition: all 0.3s ease;
        }

        .pdf-loader-overlay.active {
            display: flex;
        }

        .pdf-loader-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.5s ease-out;
        }

        .pdf-loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #d4a574;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin-loader 1s infinite cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .pdf-loader-text {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pdf-loader-subtext {
            font-size: 13px;
            opacity: 0.7;
            font-weight: 400;
        }

        @keyframes spin-loader {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="pdfLoader" class="pdf-loader-overlay">
        <div class="pdf-loader-card">
            <div class="pdf-loader-spinner"></div>
            <div class="pdf-loader-text">Generating PDF Report</div>
            <div class="pdf-loader-subtext">This may take a few seconds...</div>
        </div>
    </div>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <img src="assets/images/Trinetra.png" alt="" style="width: 120px; margin-bottom: -5px;">
                <h2>Quality Inspection</h2>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="employeeId">Email</label>
                    <input type="email" id="employeeId" placeholder="Enter your Email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-wrapper" style="position: relative;">
                        <input type="password" id="password" placeholder="Enter your password" required
                            style="padding-right: 40px;">
                        <button type="button" id="togglePassword" class="password-toggle"
                            onclick="togglePasswordVisibility()"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-full">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="app-header">
            <button id="backToDashboardBtn" class="btn-icon" onclick="backToDashboard()"
                style="margin-right: 15px; color: white; background: transparent; border: 1px solid white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer;">
                ‚¨Ö
            </button>
            <h1>QIS</h1>
            <div class="user-info">
                <span class="user-badge" id="employeeName">Employee</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <div class="tab-buttons">
                    <button id="btn-area" class="tab-btn active" onclick="switchTab('area')">Area Check</button>
                    <button id="btn-quality" class="tab-btn" onclick="switchTab('quality')">Quality Check</button>
                    <button id="btn-inspection" class="tab-btn" onclick="switchTab('inspection')">Room
                        Inspection</button>
                    <button id="btn-brands" class="tab-btn" onclick="switchTab('brands')">Brand & Material
                        Check</button>
                </div>

                <!-- Area Check Tab -->
                <div id="areaTab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2>Room Dimensions Management</h2>
                            <button class="btn" onclick="showRoomForm()">+ Add New Room</button>
                        </div>

                        <div id="roomFormContainer" class="hidden">
                            <form id="roomForm">
                                <div class="room-form">
                                    <div class="form-group">
                                        <label for="roomName">Room Name *</label>
                                        <input type="text" id="roomName" placeholder="e.g., Bedroom 1, Living Room"
                                            required>
                                    </div>
                                </div>

                                <h3 style="color: #473c39; margin: 20px 0;">Dimensions</h3>
                                <div id="dimensionsContainer"></div>

                                <button type="button" class="btn" onclick="addDimensionRow()" style="margin: 20px 0;">+
                                    Add Another Dimension</button>

                                <!-- Dimension Details Section -->
                                <div style="background: #f9f9f9; padding: 25px; border-radius: 12px; margin: 20px 0;">
                                    <h3 style="color: #473c39; margin-bottom: 20px;">Dimension Details</h3>

                                    <div class="form-group">
                                        <label>Ceiling Height (ft)</label>
                                        <input type="number" id="roomCeilingHeight" step="0.01"
                                            placeholder="Enter ceiling height" style="max-width: 300px;">
                                    </div>

                                    <div class="form-group">
                                        <label>Door Dimensions</label>
                                        <div id="doorDimensionsContainer"></div>
                                        <button type="button" class="btn btn-secondary" onclick="addDoorDimension()"
                                            style="margin-top: 10px;">+ Add Door</button>
                                    </div>

                                    <div class="form-group">
                                        <label>Window Dimensions</label>
                                        <div id="windowDimensionsContainer"></div>
                                        <button type="button" class="btn btn-secondary" onclick="addWindowDimension()"
                                            style="margin-top: 10px;">+ Add Window</button>
                                    </div>

                                    <div class="form-group">
                                        <label>Tile Dimensions</label>
                                        <div id="tileDimensionsContainer"></div>
                                        <button type="button" class="btn btn-secondary" onclick="addTileDimension()"
                                            style="margin-top: 10px;">+ Add Tile</button>
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button type="submit" class="btn">Save Room</button>
                                    <button type="button" class="btn btn-secondary"
                                        onclick="hideRoomForm()">Cancel</button>
                                </div>
                            </form>
                        </div>

                        <div class="rooms-list" id="roomsList"></div>

                        <div class="summary-section">
                            <h3>Total Area Summary</h3>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <label>Total Rooms</label>
                                    <div class="value" id="totalRooms">0</div>
                                </div>
                                <div class="summary-item">
                                    <label>Total Area</label>
                                    <div class="value" id="totalArea">0 sq ft</div>
                                </div>
                                <div class="summary-item">
                                    <label>Avg Room Size</label>
                                    <div class="value" id="avgArea">0 sq ft</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Check Tab -->
                <div id="qualityTab" class="tab-content">
                    <div class="card">
                        <h2 style="color: #473c39; margin-bottom: 30px;">Quality Check Overview</h2>

                        <div class="quality-overview">
                            <div class="quality-card">
                                <h3>Major Issues</h3>
                                <div class="progress-bar">
                                    <div id="majorBar" class="progress-fill progress-major">0</div>
                                </div>
                                <p id="majorStatus" class="quality-status status-good">No Issues</p>
                            </div>

                            <div class="quality-card">
                                <h3>Minor Issues</h3>
                                <div class="progress-bar">
                                    <div id="minorBar" class="progress-fill progress-minor">0</div>
                                </div>
                                <p id="minorStatus" class="quality-status status-good">No Issues</p>
                            </div>

                            <div class="quality-card">
                                <h3>Cosmetic Issues</h3>
                                <div class="progress-bar">
                                    <div id="cosmeticBar" class="progress-fill progress-cosmetic">0</div>
                                </div>
                                <p id="cosmeticStatus" class="quality-status status-good">No Issues</p>
                            </div>
                        </div>

                        <!-- Quality Checklist Section -->
                        <div class="checklist-section">
                            <h3 style="color: #473c39; margin-bottom: 20px;">Quality Checklist</h3>
                            <div class="checklist-item">
                                <p>Are all room corners in right angle?</p>
                                <label><input type="radio" name="q1" value="satisfactory"> Satisfactory</label>
                                <label><input type="radio" name="q1" value="not-satisfactory"> Not Satisfactory</label>
                                <label><input type="radio" name="q1" value="not-applicable"> Not Applicable</label>
                            </div>
                        </div>

                        <div class="water-quality-section">
                            <h3 style="color: #473c39; margin-bottom: 25px;">Water Quality Parameters</h3>
                            <div class="water-params">
                                <div class="param-card good">
                                    <label>PH Value of Water</label>
                                    <input type="number" id="phValue" step="0.1" value="7.0"
                                        style="font-size: 28px; font-weight: 700; color: #28a745; border: none; width: 100px;">
                                    <p class="range">Range: 6.5 - 8.5 ‚úì</p>
                                </div>
                                <div class="param-card good">
                                    <label>TDS (Total Dissolved Solids)</label>
                                    <input type="number" id="tdsValue" step="1" value="186"
                                        style="font-size: 28px; font-weight: 700; color: #28a745; border: none; width: 100px;">
                                    <span style="font-size: 20px; font-weight: 700; color: #28a745;"> mg/L</span>
                                    <p class="range">Less than 500 mg/L (desirable) ‚úì</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room Inspection Tab -->
                <div id="inspectionTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2>Room Quality Inspection</h2>
                            <button class="btn" onclick="showInspectionForm()">+ Add Inspection</button>
                        </div>

                        <div id="inspectionFormContainer" class="hidden">
                            <form id="inspectionForm">
                                <div class="room-form">
                                    <div class="form-group">
                                        <label for="inspectionRoom">Select Room *</label>
                                        <select id="inspectionRoom" required>
                                            <option value="">Choose a room...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="inspectionCategory">Category *</label>
                                        <select id="inspectionCategory" required onchange="updateIssueDropdown()">
                                            <option value="">Select category...</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="issueDescription">Issue Description *</label>
                                    <div style="position: relative;">
                                        <input type="text" id="issueDescription"
                                            placeholder="Search or select an issue..." required autocomplete="off"
                                            oninput="handleIssueInput()" onfocus="showIssueDropdown()"
                                            style="padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; width: 100%;">
                                        <div id="issueDropdown" class="issue-dropdown hidden"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="issueType">Issue Type *</label>
                                    <select id="issueType" required
                                        style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; font-family: inherit;">
                                        <option value="Major">Major</option>
                                        <option value="Minor">Minor</option>
                                        <option value="Cosmetic">Cosmetic</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Capture Photos (Required)</label>

                                    <div class="image-upload-options" style="display:flex; gap:10px;">
                                        <div class="image-upload-area" onclick="openCamera()">
                                            <p style="color:#d4a574;font-size:18px;">üì∏ Take Photo</p>
                                            <p style="color:#666;font-size:14px;">Open Camera</p>
                                        </div>
                                        <div class="image-upload-area" onclick="openGallery()">
                                            <p style="color:#d4a574;font-size:18px;">üñºÔ∏è Choose from Gallery</p>
                                            <p style="color:#666;font-size:14px;">Select Photo</p>
                                        </div>
                                    </div>

                                    <!-- Live Camera Preview -->
                                    <video id="camera" autoplay playsinline
                                        style="display:none;width:100%;margin-top:15px;border-radius:10px;"></video>


                                    <!-- Capture Button -->
                                    <div
                                        style="margin-top:15px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                                        <button type="button" id="captureBtn" class="btn btn-small"
                                            style="display:none;" onclick="capturePhoto()">üì∏ Capture Photo</button>
                                        <button type="button" id="closeCameraBtn" class="btn btn-secondary btn-small"
                                            style="display:none;" onclick="closeCamera()">‚úñ Close</button>
                                        <button type="button" id="flipBtn" class="btn btn-secondary btn-small"
                                            style="display:none;" onclick="flipCamera()">üîÑ Flip Camera</button>
                                    </div>

                                    <canvas id="canvas" style="display:none;"></canvas>

                                    <input type="file" id="galleryInput" accept="image/*" multiple style="display:none;"
                                        onchange="previewImages(event)">

                                    <!-- Preview Area -->
                                    <div id="imagePreview" class="image-preview"></div>
                                </div>

                                <div class="button-group" style="margin-top: 30px;">
                                    <button type="submit" class="btn">üíæ Save & Add Another</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideInspectionForm()">Done
                                        / Close</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="inspectionsList" class="issue-list"></div>
                </div>
            </div>

            <!-- Brand & Material Check Tab -->
            <div id="brandsTab" class="tab-content">
                <div class="card">
                    <h2 style="color: #473c39; margin-bottom: 30px;">Brand & Material Verification</h2>

                    <div id="roomBrandMaterialContainer"></div>

                    <div class="button-group"
                        style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 15px; justify-content: flex-end;">
                        <span id="lastSavedAt"
                            style="color: #888; font-size: 13px; align-self: center; margin-right: auto;">Last saved:
                            Never</span>
                        <button type="button" class="btn"
                            style="background: #f8f9fa; color: #473c39; border: 1px solid #ddd;"
                            onclick="saveInspectionDraft()">üíæ Save Draft</button>
                        <button type="button" class="btn btn-primary" style="padding: 12px 30px; font-weight: 600;"
                            onclick="submitFinalInspection()">‚úÖ Submit Final Inspection</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // API Configuration - Backend runs on port 5001
        const API_BASE_URL = window.location.origin + "/api";
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        // Get URL parameters for task or inspection
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('taskId');
        const inspectionId = urlParams.get('inspectionId');

        console.log('üîê App.html loaded');
        console.log('Token:', authToken ? '‚úÖ Present' : '‚ùå Missing');
        console.log('User:', currentUser.name || 'No user');
        console.log('TaskId:', taskId);
        console.log('InspectionId:', inspectionId);

        // Protected Route: Only INSPECTOR can access this page with taskId/inspectionId
        if (authToken && currentUser.role) {
            if (currentUser.role === 'ADMIN') {
                console.log('‚ö†Ô∏è Admin cannot access inspection form. Redirecting...');
                window.location.href = '/admin-dashboard.html';
                throw new Error('Admin cannot perform inspections');
            }
            if (currentUser.role !== 'INSPECTOR') {
                console.log('‚ö†Ô∏è Unauthorized role. Redirecting to login...');
                localStorage.clear();
                window.location.href = '/';
                throw new Error('Unauthorized role');
            }
        }

        // Immediately show mainApp if coming from inspector dashboard (has taskId/inspectionId)
        if (taskId || inspectionId) {
            console.log('üìã Task/Inspection mode detected, showing mainApp immediately');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }



        // If we have authToken (from inspector dashboard), show mainApp immediately
        if (authToken && (taskId || inspectionId)) {
            console.log('üìã Task/Inspection with auth token, showing mainApp');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('employeeName').textContent = currentUser.name || 'Inspector';
        }


        // Initialize on page load
        let rooms = [];
        let inspections = [];
        let uploadedImages = [];
        let currentEmployee = "";
        let selectedIssue = null;
        let currentTaskData = null;
        let currentInspectionData = null;

        // --- IndexedDB for Offline Support ---
        const inspectionDB = {
            db: null,

            async init() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('InspectionDB', 1);

                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('inspections')) {
                            db.createObjectStore('inspections', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('reports')) {
                            db.createObjectStore('reports', { keyPath: 'id' });
                        }
                    };

                    request.onsuccess = (e) => {
                        this.db = e.target.result;

                        // Handle generic error / close events
                        this.db.onversionchange = () => {
                            this.db.close();
                            this.db = null;
                        };
                        this.db.onclose = () => {
                            this.db = null;
                        };

                        console.log('‚úÖ IndexedDB Initialized');
                        resolve(this.db);
                    };

                    request.onerror = (e) => {
                        console.error('‚ùå IndexedDB Error:', e.target.error);
                        reject(e.target.error);
                    };
                });
            },

            async ensureDb() {
                if (!this.db) {
                    return await this.init();
                }
                return this.db;
            },

            async saveInspection(inspection) {
                try {
                    await this.ensureDb();
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(['inspections'], 'readwrite');
                        const store = tx.objectStore('inspections');
                        const request = store.put(inspection);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    // If connection closing error, try once more
                    this.db = null;
                    await this.ensureDb();
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(['inspections'], 'readwrite');
                        const store = tx.objectStore('inspections');
                        const request = store.put(inspection);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                }
            },

            async getInspection(id) {
                await this.ensureDb();
                return new Promise((resolve, reject) => {
                    try {
                        const tx = this.db.transaction(['inspections'], 'readonly');
                        const store = tx.objectStore('inspections');
                        const request = store.get(id);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    } catch (err) { reject(err); }
                });
            },

            async getAllInspections() {
                await this.ensureDb();
                return new Promise((resolve, reject) => {
                    try {
                        const tx = this.db.transaction(['inspections'], 'readonly');
                        const store = tx.objectStore('inspections');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    } catch (err) { reject(err); }
                });
            },

            async deleteInspection(id) {
                await this.ensureDb();
                return new Promise((resolve, reject) => {
                    try {
                        const tx = this.db.transaction(['inspections'], 'readwrite');
                        const store = tx.objectStore('inspections');
                        const request = store.delete(id);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    } catch (err) { reject(err); }
                });
            }
        };

        // Initialize IndexedDB
        inspectionDB.init().catch(console.error);

        // --- Persistence Logic ---
        async function saveSessionState() {
            const state = {
                rooms,
                inspections,
                currentEmployee,
                currentTaskData,
                currentInspectionData,
                activeTab: document.querySelector('.tab-content.active')?.id || 'areaTab',
                water: {
                    ph: parseFloat(document.getElementById('phValue')?.value) || 7.0,
                    tds: parseFloat(document.getElementById('tdsValue')?.value) || 186
                },
                checklist: {
                    rightAngles: document.querySelector('input[name="q1"]:checked')?.value || 'not-checked'
                },
                timestamp: Date.now()
            };

            // 1. Save to LocalStorage (Light metadata)
            localStorage.setItem('inspection_session', JSON.stringify({
                ...state,
                inspections: state.inspections.map(i => ({ ...i, images: [] })) // Strip images for LS to stay under 5MB
            }));

            // 2. Save to IndexedDB (Full state with images)
            try {
                await inspectionDB.saveInspection({
                    id: 'current_session',
                    data: state,
                    updatedAt: new Date().toISOString()
                });
            } catch (e) {
                console.warn('Failed to save to IndexedDB:', e);
            }

            // 3. Update UI
            const lastSaved = document.getElementById('lastSavedAt');
            if (lastSaved) {
                lastSaved.textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
            }
            console.log('üíæ Session auto-saved');

            // 4. Background Sync to Server (Throttled)
            if (navigator.onLine && currentInspectionData?.id) {
                const now = Date.now();
                const lastSync = parseInt(localStorage.getItem('last_server_sync') || '0');
                if (now - lastSync > 60000) { // Max once per minute
                    localStorage.setItem('last_server_sync', now.toString());
                    console.log('‚òÅÔ∏è Syncing draft to server in background...');
                    saveInspectionDraft(true); // Call with silent=true flag
                }
            }
        }

        async function restoreSessionState() {
            let state = null;

            // 1. Try IndexedDB first (most complete)
            try {
                const idbState = await inspectionDB.getInspection('current_session');
                if (idbState && (Date.now() - new Date(idbState.updatedAt).getTime() < 48 * 60 * 60 * 1000)) {
                    state = idbState.data;
                    console.log('üì¶ Restored session from IndexedDB');
                }
            } catch (e) {
                console.warn('IndexedDB restoration failed:', e);
            }

            // 2. Fallback to LocalStorage
            if (!state) {
                const saved = localStorage.getItem('inspection_session');
                if (saved) {
                    try {
                        const lsState = JSON.parse(saved);
                        if (Date.now() - lsState.timestamp < 24 * 60 * 60 * 1000) {
                            state = lsState;
                            console.log('üìÑ Restored session from LocalStorage');
                        }
                    } catch (e) { }
                }
            }

            if (state) {
                try {
                    // IMPORTANT: Validate session matches current URL context
                    const savedTaskId = state.currentTaskData?.id;
                    const savedInspectionId = state.currentInspectionData?.id;

                    if ((taskId && savedTaskId && taskId !== savedTaskId) ||
                        (inspectionId && savedInspectionId && inspectionId !== savedInspectionId)) {
                        console.warn('‚ö†Ô∏è Session from different task. Not restoring data.');
                        return;
                    }

                    rooms = state.rooms || [];
                    inspections = state.inspections || [];
                    currentEmployee = state.currentEmployee || "";
                    currentTaskData = state.currentTaskData || null;
                    currentInspectionData = state.currentInspectionData || null;

                    // Restore Water Quality
                    if (state.water) {
                        if (document.getElementById('phValue')) document.getElementById('phValue').value = state.water.ph;
                        if (document.getElementById('tdsValue')) document.getElementById('tdsValue').value = state.water.tds;
                    }

                    // Restore Checklist
                    if (state.checklist?.rightAngles) {
                        const radio = document.querySelector(`input[name="q1"][value="${state.checklist.rightAngles}"]`);
                        if (radio) radio.checked = true;
                    }

                    // Restore UI lists
                    updateRoomsList();
                    updateInspectionsList();
                    updateBrandMaterialSections();
                    calculateQualityMetrics();

                    // Restore Tab
                    if (state.activeTab) {
                        const tabMap = {
                            'areaTab': 'area',
                            'qualityTab': 'quality',
                            'inspectionTab': 'inspection',
                            'brandsTab': 'brands'
                        };
                        const tabName = tabMap[state.activeTab];
                        if (tabName) {
                            setTimeout(() => {
                                switchTab(tabName);
                                document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                                    btn.classList.remove('active');
                                    if (['area', 'quality', 'inspection', 'brands'][i] === tabName) {
                                        btn.classList.add('active');
                                    }
                                });
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.error('Failed to apply restored session:', e);
                }
            }
        }

        // Initialize on page load
        (async () => {
            try {
                // Restore session first
                await restoreSessionState();

                if (taskId) {
                    await loadTaskData(taskId);
                } else if (inspectionId) {
                    await loadInspectionData(inspectionId);
                }

                // Setup Auto-Save Triggers
                setupAutoSaveListeners();

                // Periodic backup
                setInterval(saveSessionState, 30000); // Every 30 seconds as double safety
            } catch (err) {
                console.error('Initialization error:', err);
            }
        })();

        function setupAutoSaveListeners() {
            // Monitor inputs
            ['phValue', 'tdsValue'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', () => saveSessionState());
            });

            // Monitor radio buttons (checklist)
            document.querySelectorAll('input[name="q1"]').forEach(radio => {
                radio.addEventListener('change', () => saveSessionState());
            });

            console.log('üîÑ Auto-save listeners active');
        }





        // Initialize App on page load
        (async () => {
            const initializeApp = async () => {
                document.getElementById('employeeName').textContent = currentUser.name || 'Inspector';
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                if (taskId) {
                    console.log('üìã Loading task:', taskId);
                    await loadTaskData(taskId);

                    if (currentTaskData) {
                        console.log('üöÄ Starting or retrieving inspection for task...');
                        try {
                            const response = await apiCall(`/tasks/${taskId}/inspections`, 'POST');
                            if (response.success) {
                                currentInspectionData = response.data;
                                console.log(`‚úÖ ${response.message}`, currentInspectionData.id);

                                if (currentInspectionData.inspectionJson) {
                                    console.log('üìù Pre-populating form with existing inspection data.');
                                }
                            } else {
                                throw new Error(response.message);
                            }
                        } catch (error) {
                            console.error('‚ùå Failed to start inspection for task:', error);
                            alert('Error: Could not initialize inspection for this task. ' + error.message);
                            window.location.href = '/inspector-dashboard.html';
                        }
                    }
                } else if (inspectionId) {
                    console.log('üìù Loading inspection directly:', inspectionId);
                    await loadInspectionData(inspectionId);
                }
            };

            if (authToken && currentUser.name) {
                console.log('‚úÖ User logged in:', currentUser.name);
                await initializeApp();
            } else if (taskId || inspectionId) {
                console.warn('‚ö†Ô∏è No token but task/inspection present.');
                await initializeApp();
            } else {
                console.log('üîì Not logged in, showing login');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        })();



        // Issue database - dynamically loaded from prefillJson (ERI Workflow)
        // If prefillJson.categories exists, it overrides this default
        let issueDatabase = {
            "Flooring": [
                { title: "Flooring: Are all the room corners in right angle?", type: "Major" },
                { title: "Flooring: Are the Butt filling grooves uniform?", type: "Major" },
                { title: "Flooring: Are the Butt filling grooves uniform?", type: "Minor" },
                { title: "Flooring: Any colour & shade variation observed in floor tiles", type: "Major" },
                { title: "Flooring: Any colour & shade variation observed in floor tiles", type: "Minor" },
                { title: "Flooring: Hollowness or debonding observed in floor tiles after fixing", type: "Major" },
                { title: "Flooring: Any cracks / damage / bends observed in floor tiles after fixing", type: "Major" },
                { title: "Flooring: Tile joints of floor tile and skirting matching / uniform & no undulations at joints", type: "Minor" },
                { title: "Flooring: Are gaps sealing of floor tiles / between skirting & flooring tiles filled properly", type: "Major" },
                { title: "Flooring: Any defects found in skirting", type: "Major" },
                { title: "Flooring: Any level differences observed in skirting", type: "Minor" },
                { title: "Flooring: Any gaps observed in skirting", type: "Minor" },
                { title: "Flooring: Any gaps observed between door frame & flooring / skirting", type: "Major" },
                { title: "Flooring: Any defects found in uniformity/ straight line of joint", type: "Minor" },
                { title: "Flooring: Any offsets observed in the flooring", type: "Major" },
                { title: "Flooring: Any offsets observed in the skirting", type: "Major" },
                { title: "Flooring: Are all spacers removed after flooring work", type: "Minor" },
                { title: "Flooring: Are all spacers removed after flooring work", type: "Cosmetic" },
                { title: "Flooring: Any cut-pieces used at the end are of same sizes and uniformly laid", type: "Major" }
            ],
            "Wooden Flooring": [
                { title: "Wooden Flooring: Are all glue marks removed", type: "Cosmetic" },
                { title: "Wooden Flooring: Any hollowness observed below fixed laminates when checked by tamping with wooden mallet", type: "Major" },
                { title: "Wooden Flooring: Are there any stains or scratches observed in the laminates?", type: "Minor" },
                { title: "Wooden Flooring: Is the wooden flooring area appearing in perfect horizontal plane and level", type: "Major" },
                { title: "Wooden Flooring: Are all the joints between panels uniform?", type: "Major" },
                { title: "Wooden Flooring: Polish, Sheen and Texture on flooring not disturbed", type: "Minor" },
                { title: "Wooden Flooring: Any gaps observed between door frame & wooden flooring / skirting", type: "Major" },
                { title: "Wooden Flooring: Does the flooring have any swelling or warping or cracks", type: "Major" },
                { title: "Wooden Flooring: Any damages observed on skirting", type: "Minor" }
            ],
            "Marble/Granite Flooring": [
                { title: "Marble/Granite Flooring: Consistency in colour", type: "Minor" },
                { title: "Marble/Granite Flooring: Consistency in design pattern", type: "Minor" },
                { title: "Marble/Granite Flooring: Any paint marks on marble flooring?", type: "Cosmetic" },
                { title: "Marble/Granite Flooring: Any paint marks on marble flooring?", type: "Minor" },
                { title: "Marble/Granite Flooring: Grinding and Polishing work completed", type: "Major" },
                { title: "Marble/Granite Flooring: Hollowness or debonding observed in marble/granite slabs after fixing", type: "Major" },
                { title: "Marble/Granite Flooring: Any cracks observed in marble / granite slabs", type: "Major" }
            ],
            "Doors": [
                { title: "Doors: Door frames, shutters are defect less without any bend, cracks, warpage or scratches", type: "Major" },
                { title: "Doors: Shutters are operating smoothly without any noise", type: "Major" },
                { title: "Doors: Shutter and frame in same line / plan after closing", type: "Minor" },
                { title: "Doors: All types of door fittings, hinges screwed properly & operating smoothly", type: "Major" },
                { title: "Doors: Polishing & painting done on all sides including top and bottom of door shutter", type: "Minor" },
                { title: "Doors: Sealant materials applied to fill up the gaps between walls & door frame", type: "Major" },
                { title: "Doors: Sealant materials applied to fill up the gaps between walls & door frame", type: "Minor" },
                { title: "Doors: Cover moulding patti to all door frames fixed with proper corner finishing", type: "Minor" },
                { title: "Doors: Door fittings are free from paint, dust and rust", type: "Cosmetic" },
                { title: "Doors: Door fittings are free from paint, dust and rust", type: "Minor" },
                { title: "Doors: Gap between door frame and shutter within tolerance limit & uniform", type: "Minor" },
                { title: "Doors: Joints in lipping patti only at corners", type: "Cosmetic" },
                { title: "Doors: Magnetic / rubber door catcher provided to avoid banging of door and fixed properly", type: "Major" },
                { title: "Doors: Rubber gasket fixed properly /having proper corner finish", type: "Minor" },
                { title: "Doors: Any nails or sharp objects are protruding from the frame?", type: "Major" },
                { title: "Doors: Any damages/cracks/scratch marks observed on glass", type: "Major" },
                { title: "Doors: Proper frame alignment found", type: "Major" },
                { title: "Doors: Proper frame alignment found", type: "Minor" },
                { title: "Doors: Door jamb gap maintained equally on both sides", type: "Minor" },
                { title: "Doors: Any gaps observed in door frame joints", type: "Minor" },
                { title: "Doors: Door bottom sweeps, gap between floor and door bottom is in tolerance", type: "Minor" },
                { title: "Doors: Any wall damaged during fixing of doors", type: "Major" }
            ],
            "Windows": [
                { title: "Windows: Any windows frame & shutters bend / damaged?", type: "Major" },
                { title: "Windows: Windows shutters operating smooth & noise free", type: "Major" },
                { title: "Windows: All types of window fittings fixed properly & operating smoothly", type: "Major" },
                { title: "Windows: Window fittings are free from paint and rust", type: "Cosmetic" },
                { title: "Windows: Water drainage from window tracks satisfactory", type: "Major" },
                { title: "Windows: All gaps between frame are sealed with sealant from internal & external side", type: "Major" },
                { title: "Windows: Any leakage / dampness observed after sealed with sealant", type: "Major" },
                { title: "Windows: Any powder coating anodizing got damaged", type: "Minor" },
                { title: "Windows: Glass cleaned and properly checked for stains / paint marks", type: "Cosmetic" },
                { title: "Windows: Glass cleaned and properly checked for scratches", type: "Minor" },
                { title: "Windows: Glass cleaned and properly checked for cracks", type: "Major" },
                { title: "Windows: Any gaps observed between shutter and frame member joints", type: "Minor" },
                { title: "Windows: Shutters fixed properly and cannot be easily removed from frame", type: "Major" },
                { title: "Windows: Any sideways movement in shutter after locking", type: "Major" },
                { title: "Windows: Fly mesh provided for windows to avoid entry of insects", type: "Minor" },
                { title: "Windows: Any damages found in fly mesh or fixing issues", type: "Major" },
                { title: "Windows: Wool piles / rubber gasket fixed properly", type: "Minor" },
                { title: "Windows: Fins shutter and frame in plumb", type: "Minor" },
                { title: "Windows: No damage, cracks, hollowness observed in window sill stone after fixing", type: "Major" },
                { title: "Windows: Is sealant application uniform without any bulging", type: "Cosmetic" },
                { title: "Windows: Any wall damaged during fixing of window frames", type: "Major" },
                { title: "Windows: Screw fitting to frame satisfactory", type: "Minor" }
            ],
            "Wall Finish": [
                { title: "Wall Finish: Any dampness observed on walls", type: "Major" },
                { title: "Wall Finish: Any dampness observed on ceiling", type: "Major" },
                { title: "Wall Finish: Shade of paint is uniform at all places", type: "Major" },
                { title: "Wall Finish: Shade of paint is uniform at all places", type: "Cosmetic" },
                { title: "Wall Finish: Any air bubbles/Scratches/peeling off observed in walls", type: "Major" },
                { title: "Wall Finish: Any cracks / damages observed in walls", type: "Major" },
                { title: "Wall Finish: Any air bubbles/Scratches/peeling off observed in ceiling", type: "Major" },
                { title: "Wall Finish: Any cracks / damages observed in ceiling", type: "Major" },
                { title: "Wall Finish: Surface finish of painted walls and ceiling uniform", type: "Cosmetic" },
                { title: "Wall Finish: Electrical cut outs in false ceiling properly sealed", type: "Major" },
                { title: "Wall Finish: Undulations in the wall / ceiling surface not observed", type: "Minor" },
                { title: "Wall Finish: Corners and edges are sharp and finished satisfactorily", type: "Minor" },
                { title: "Wall Finish: Uniformity in the level of horizontal offsets on wall", type: "Cosmetic" },
                { title: "Wall Finish: Any water leakage observed in balcony / open to sky ceiling", type: "Major" }
            ],
            "Electrical Work": [
                { title: "Electrical Work: Any gap observed between switch plate & wall/tile surface", type: "Major" },
                { title: "Electrical Work: Any gap observed between switch plate & wall/tile surface", type: "Minor" },
                { title: "Electrical Work: Are switches operating smoothly", type: "Major" },
                { title: "Electrical Work: Are the switches functioning?", type: "Major" },
                { title: "Electrical Work: All switch boards fixed in line and level", type: "Minor" },
                { title: "Electrical Work: All switch boards fixed in line and level", type: "Cosmetic" },
                { title: "Electrical Work: Any stains / paint marks found on switch plates", type: "Minor" },
                { title: "Electrical Work: Any damages / cracks found on switch plates", type: "Major" },
                { title: "Electrical Work: Is earthing done for all electrical points", type: "Major" },
                { title: "Electrical Work: Are fan regulators working smoothly", type: "Major" },
                { title: "Electrical Work: Provision for exhaust fan available", type: "Major" },
                { title: "Electrical Work: Provision for geyser available", type: "Major" }
            ],
            "Electrical D.B. Work": [
                { title: "Electrical D.B. Work: Is the Voltage between 220 - 240 V?", type: "Major" },
                { title: "Electrical D.B. Work: Circuit diagram provided inside DB cover", type: "Minor" },
                { title: "Electrical D.B. Work: ELCB / RCCB installed (30mA)", type: "Cosmetic" },
                { title: "Electrical D.B. Work: ELCB / RCCB MCB fitted & functioning", type: "Minor" }
            ],
            "Plumbing": [
                { title: "Plumbing: Is Nahani Trap fixed at required location", type: "Minor" },
                { title: "Plumbing: Are all water outlets getting adequate water pressure", type: "Major" },
                { title: "Plumbing: Adequate water temperature through hot water tap", type: "Minor" },
                { title: "Plumbing: Functioning of control valve satisfactory", type: "Major" },
                { title: "Plumbing: Adequate slope provided to drain pipes", type: "Major" }
            ],
            "Sanitary ware": [
                { title: "Sanitary ware: Functioning of CP and sanitary fittings satisfactory", type: "Major" },
                { title: "Sanitary ware: Fixing of CP and sanitary fittings satisfactory", type: "Major" },
                { title: "Sanitary ware: Any leakage observed from CP and sanitary fittings", type: "Major" },
                { title: "Sanitary ware: All CP and sanitary fittings free from cracks", type: "Major" },
                { title: "Sanitary ware: Separate stop cock provided for each unit", type: "Cosmetic" },
                { title: "Sanitary ware: Ball valve operated through window", type: "Minor" }
            ],
            "Modular Kitchen & Kitchen Platform": [
                { title: "Any damages found on modular / pre-fitted furniture", type: "Major" },
                { title: "Functioning of modular furniture doors satisfactory", type: "Major" },
                { title: "Functioning of modular furniture drawers satisfactory", type: "Major" },
                { title: "Any cracks found in granite stone", type: "Major" },
                { title: "Vertical granite above platform polished properly", type: "Minor" },
                { title: "Any leakage below the platform observed", type: "Major" },
                { title: "Kitchen steel sink gaps sealed with sealant from above", type: "Major" },
                { title: "Kitchen steel sink gaps filled with mortar from below", type: "Major" },
                { title: "Adequate space provided for gas cylinder", type: "Minor" },
                { title: "Hollow sound observed in stone frame", type: "Minor" },
                { title: "Height of kitchen platform satisfactory", type: "Minor" },
                { title: "Size variation observed on kitchen platform", type: "Major" },
                { title: "Adequate slope provided for draining water", type: "Major" },
                { title: "Anchorage of vertical supports satisfactory", type: "Major" },
                { title: "Exposed edges chamfered", type: "Major" },
                { title: "Gas pipe provision provided and finished satisfactorily", type: "Major" }
            ],
            "Handrails / MS grills": [
                { title: "Balcony handrails perfectly horizontal from FFL", type: "Cosmetic" },
                { title: "Junctions of vertical and horizontal rails finished properly", type: "Minor" },
                { title: "C/C distance between vertical rails satisfactory", type: "Minor" },
                { title: "Painting to hand railing / grills done", type: "Minor" },
                { title: "Any corrosion observed on rails", type: "Major" },
                { title: "Horizontal rail end caps provided", type: "Minor" },
                { title: "Caps provided on fastener tops", type: "Minor" },
                { title: "Railing alignment properly done", type: "Minor" },
                { title: "Proper anchorage support observed", type: "Major" },
                { title: "Railing height as per safety norms (1.2m)", type: "Major" }
            ]
        };

        // Dynamic loader for ERI workflow - called after task loads
        function loadIssueDatabase() {
            if (currentTaskData?.prefillJson?.categories) {
                issueDatabase = currentTaskData.prefillJson.categories;
                console.log('‚úÖ Loaded issue categories from prefillJson');
            }
        }

        // Back Button Logic
        function backToDashboard() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabs = ['areaTab', 'qualityTab', 'inspectionTab', 'brandsTab'];
            const currentIndex = tabs.indexOf(activeTab.id);

            if (currentIndex === 0) {
                // If on first tab, confirm and go back to dashboard
                if (confirm('Go back to Inspector Dashboard? Unsaved progress in this form will be kept in Draft.')) {
                    window.location.href = '/inspector-dashboard.html';
                }
            } else if (currentIndex > 0) {
                // Go to previous tab
                const prevTab = tabs[currentIndex - 1];
                const prevTabName = prevTab.replace('Tab', '');
                switchTab(prevTabName);
            }
        }

        document.getElementById('loginForm').addEventListener("submit", async e => {
            e.preventDefault();
            const id = document.getElementById('employeeId').value;
            const pwd = document.getElementById('password').value;

            console.log('üîê Login attempt:', id);
            console.log('üì° Calling API:', `${API_BASE_URL}/auth/login`);

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employeeId: id,
                        password: pwd
                    })
                });

                console.log('‚úÖ Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Login successful:', data);
                    authToken = data.token;
                    currentUser = data.user;
                    currentEmployee = data.user.id;

                    // Store token in localStorage based on role (Multi-role support)
                    if (data.user.role === 'ADMIN') {
                        localStorage.setItem('adminToken', authToken);
                        localStorage.setItem('adminUser', JSON.stringify(data.user));
                    } else if (data.user.role === 'INSPECTOR') {
                        localStorage.setItem('inspectorToken', authToken);
                        localStorage.setItem('inspectorUser', JSON.stringify(data.user));
                        // Also keep generic for legacy app compatibility during transition
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                    } else {
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                    }

                    // Redirect based on role
                    if (data.user.role === 'ADMIN') {
                        window.location.href = '/admin-dashboard.html';
                    } else if (data.user.role === 'INSPECTOR') {
                        window.location.href = '/inspector-dashboard.html';
                    } else {
                        // Legacy behavior for other roles
                        document.getElementById('employeeName').textContent = data.user.name;
                        document.getElementById('loginPage').classList.add("hidden");
                        document.getElementById('mainApp').classList.remove("hidden");
                    }
                } else {
                    const error = await response.json();
                    console.error('‚ùå Login failed:', response.status, error);
                    alert(error.message || "Invalid credentials");
                }
            } catch (error) {
                console.error('‚ùå Login error (network):', error);
                alert("Connection error. Make sure backend is running on http://localhost:5001");
            }
        });

        // Password visibility toggle
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('togglePassword');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà'; // Hidden eye
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è'; // Open eye
            }
        }

        function logout() {
            authToken = '';
            currentUser = {};
            currentEmployee = "";
            rooms = [];
            inspections = [];
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('inspection_session');
            document.getElementById('loginPage').classList.remove("hidden");
            document.getElementById('mainApp').classList.add("hidden");
            document.getElementById('loginForm').reset();
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            const tabId = tabName + 'Tab';
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Activate the corresponding button
            const btnId = 'btn-' + tabName;
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('active');
            }

            // Tab-specific logic
            if (tabName === 'inspection') {
                updateInspectionRoomSelect();
            }
            if (tabName === 'brands') {
                updateBrandMaterialSections();
            }

            // Save active tab for persistence
            if (typeof saveSessionState === 'function') {
                saveSessionState();
            }
        }

        // Load task data from API and pre-populate form
        async function loadTaskData(taskId) {
            try {
                console.log('üì• Loading task:', taskId);
                const taskData = await apiCall(`/tasks/${taskId}`);
                if (taskData.success) {
                    currentTaskData = taskData.data;
                    console.log('‚úÖ Task loaded:', currentTaskData);
                    // Pre-fill task details in form if needed
                    document.getElementById('employeeName').textContent = currentUser.name || 'Inspector';
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('loginPage').classList.add('hidden');
                }
            } catch (error) {
                console.error('‚ùå Error loading task:', error);
                alert('Failed to load task. Redirecting to dashboard.');
                window.location.href = '/inspector-dashboard.html';
            }
        }

        // Load inspection data from API
        async function loadInspectionData(inspectionId) {
            try {
                console.log('üì• Loading inspection:', inspectionId);
                const inspectionData = await apiCall(`/inspections/${inspectionId}`);
                if (inspectionData.success) {
                    currentInspectionData = inspectionData.data;
                    console.log('‚úÖ Inspection loaded:', currentInspectionData);

                    // Ensure task data is available for metadata collection
                    if (currentInspectionData.task) {
                        currentTaskData = currentInspectionData.task;
                        console.log('üîó Task data linked from inspection:', currentTaskData);
                    }

                    document.getElementById('employeeName').textContent = currentUser.name || 'Inspector';
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('loginPage').classList.add('hidden');
                    // TODO: Pre-populate forms with currentInspectionData.inspectionJson
                }
            } catch (error) {
                console.error('‚ùå Error loading inspection:', error);

                // If we have local data (restored from session) and error is 404, keep local
                if (currentInspectionData && currentInspectionData.id === inspectionId && error.message.includes('404')) {
                    console.warn('‚ö†Ô∏è Inspection not found on server (404), but found in local session. Using local data.');
                    currentInspectionData._serverMissing = true;
                    // Optional: remove loading overlay if any
                    document.getElementById('employeeName').textContent = currentUser.name || 'Inspector';
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('loginPage').classList.add('hidden');
                    return;
                }

                alert('Failed to load inspection from server and no local backup found. Redirecting to dashboard.');
                window.location.href = '/inspector-dashboard.html';
            }
        }

        // --- New functions for inspection data handling ---

        // Function to collect all inspection data from the forms
        function collectInspectionData(forSubmission = false) {
            // Ensure phValue and tdsValue are numbers, default to 0 if not found or invalid
            const phValue = parseFloat(document.getElementById('phValue')?.value) || 0;
            const tdsValue = parseFloat(document.getElementById('tdsValue')?.value) || 0;

            const frontendData = {
                // Meta information (from currentTaskData)
                clientName: currentTaskData?.clientName || 'Unknown Client',
                propertyAddress: currentTaskData?.propertyAddress || 'Unknown Address',
                verifierName: currentTaskData?.assignedTo?.name || currentUser?.name || 'Unknown Inspector',
                inspectorName: currentUser?.name || 'Unknown Inspector',
                inspectionDate: new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: '2-digit'
                }),
                generatedDate: new Date().toISOString(),

                // Room data
                rooms: rooms,

                // Inspection data
                inspections: inspections,

                // Checklist data
                checklist: {
                    rightAngles: document.querySelector('input[name="q1"]:checked')?.value || 'not-checked'
                },

                // Quality metrics
                quality: {
                    major: inspections.filter(i => i.issueType === 'Major').length,
                    minor: inspections.filter(i => i.issueType === 'Minor').length,
                    cosmetic: inspections.filter(i => i.issueType === 'Cosmetic').length,
                    total: inspections.length,
                    water: {
                        ph: phValue,
                        tds: tdsValue
                    }
                },

                // Summary statistics
                summary: {
                    totalRooms: rooms.length,
                    totalArea: parseFloat(rooms.reduce((a, b) => a + b.totalArea, 0).toFixed(2)),
                    avgRoomSize: rooms.length ?
                        parseFloat((rooms.reduce((a, b) => a + b.totalArea, 0) / rooms.length).toFixed(2)) : 0
                }
            };

            // FIX: Transform for Server Schema if submitting to prevent 500 Error
            // The server expects valid schema-compliant JSON for 'submit'
            if (forSubmission) {
                let baseJson = currentInspectionData?.prefillJson;

                // Handle string scenario (if from LocalStorage/Prisma raw)
                if (typeof baseJson === 'string') {
                    try { baseJson = JSON.parse(baseJson); } catch (e) { baseJson = null; }
                }

                // Create fallback if missing (though strictly it should exist)
                if (!baseJson) {
                    baseJson = {
                        schema_version: '1.0',
                        metadata: {},
                        rooms: [],
                        derived: {},
                        audit: {}
                    };
                } else {
                    // Deep copy to avoid mutating original prefill
                    baseJson = JSON.parse(JSON.stringify(baseJson));
                }

                // 1. Fill Metadata
                baseJson.metadata = baseJson.metadata || {};
                baseJson.metadata.client_name = frontendData.clientName;
                if (!baseJson.metadata.client_email && !baseJson.metadata.client_phone) {
                    baseJson.metadata.client_email = 'submitted@via.app';
                }
                baseJson.metadata.extension_data = frontendData; // Save UI state

                // 2. Map Frontend Rooms to Backend Rooms (Handling Dynamic Rooms)
                const prefillRooms = (baseJson.rooms && Array.isArray(baseJson.rooms)) ? baseJson.rooms : [];
                const finalRooms = [];

                // Use frontend rooms as the source of truth for rooms present
                rooms.forEach(frontendRoom => {
                    const roomNameTrimmed = frontendRoom.name.trim();

                    // Try to find matching room in prefill schema
                    let schemaRoom = prefillRooms.find(r =>
                        r.room_label === roomNameTrimmed ||
                        r.room_id === roomNameTrimmed.toLowerCase().replace(/\s+/g, '_')
                    );

                    const roomDefects = inspections.filter(i => i.room.trim() === roomNameTrimmed);
                    const getStatusForCategory = (category) => {
                        const defects = roomDefects.filter(d => d.category === category);
                        if (defects.length === 0) return 'PASS';
                        const severities = defects.map(d => d.issueType);
                        if (severities.includes('Critical')) return 'CRITICAL';
                        if (severities.includes('Major')) return 'MAJOR';
                        if (severities.includes('Minor')) return 'MINOR';
                        return 'COSMETIC';
                    };

                    if (schemaRoom) {
                        const newRoom = JSON.parse(JSON.stringify(schemaRoom));

                        // Categories found in defects for this room
                        const activeCategories = [...new Set(roomDefects.map(d => d.category))];
                        const schemaCategories = newRoom.items.map(i => i.category);

                        // Update existing items from schema
                        newRoom.items.forEach(item => {
                            item.status = getStatusForCategory(item.category);
                        });

                        // ADD extra categories that user might have added but aren't in schema
                        activeCategories.forEach(cat => {
                            if (!schemaCategories.includes(cat)) {
                                newRoom.items.push({
                                    item_id: `${roomNameTrimmed.toLowerCase().replace(/\s+/g, '_')}_${cat.toLowerCase().replace(/\s+/g, '_')}`,
                                    label: `${cat} Check`,
                                    category: cat,
                                    status: getStatusForCategory(cat),
                                    remarks: null,
                                    photos: []
                                });
                            }
                        });

                        finalRooms.push(newRoom);
                    } else {
                        // Dynamic Room - Construct Schema on the Fly
                        const dynamicItems = [];
                        // Get all categories that have issues in this room
                        const distinctCategories = [...new Set(roomDefects.map(d => d.category))];

                        // If no issues, add at least one item so room isn't empty/skipped
                        if (distinctCategories.length === 0) {
                            dynamicItems.push({
                                item_id: `${roomNameTrimmed.toLowerCase().replace(/\s+/g, '_')}_general`,
                                label: `General Quality`,
                                category: `General`,
                                status: 'PASS',
                                remarks: null,
                                photos: []
                            });
                        } else {
                            distinctCategories.forEach(cat => {
                                dynamicItems.push({
                                    item_id: `${roomNameTrimmed.toLowerCase().replace(/\s+/g, '_')}_${cat.toLowerCase().replace(/\s+/g, '_')}`,
                                    label: `${cat} Check`,
                                    category: cat,
                                    status: getStatusForCategory(cat),
                                    remarks: null,
                                    photos: []
                                });
                            });
                        }

                        finalRooms.push({
                            room_id: frontendRoom.id ? String(frontendRoom.id) : `room_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            room_label: roomNameTrimmed,
                            scored: true,
                            items: dynamicItems
                        });
                    }
                });

                baseJson.rooms = finalRooms;
                console.log('üì¶ Converted for Server Submission (All Items):', baseJson);
                return baseJson;
            }


            console.log('Collected Inspection Data (Frontend):', frontendData);
            return frontendData;
        }


        // Function to save inspection as a draft
        async function saveInspectionDraft(isSilent = false) {
            if (!currentInspectionData || !currentInspectionData.id) {
                alert('Error: No active inspection to save.');
                return;
            }

            const inspectionJson = collectInspectionData();
            console.log('Saving inspection draft...');

            // Prepare object to save
            const draftData = {
                ...currentInspectionData,
                inspectionJson: inspectionJson,
                status: 'IN_PROGRESS',
                lastSaved: new Date().toISOString()
            };

            // 1. Save to IndexedDB (Always)
            try {
                await inspectionDB.saveInspection(draftData);
                console.log('‚úÖ Draft saved to IndexedDB');
            } catch (e) {
                console.error('‚ùå Failed to save to IndexedDB', e);
            }

            // 2. Try to sync to server if online
            if (navigator.onLine) {
                try {
                    let response;
                    try {
                        // If we know it's missing on server, skip PUT and go straight to POST
                        if (currentInspectionData._serverMissing) {
                            throw new Error('404 Force Create');
                        }

                        response = await apiCall(`/inspections/${currentInspectionData.id}`, 'PUT', {
                            inspectionJson: inspectionJson
                        }, { silent: true });
                    } catch (err) {
                        // If 404 (Not Found), try to create via POST since it might be a new local inspection
                        // Use string matching on error message or try/catch logic
                        if (err.message && err.message.includes('404')) {
                            console.warn('‚ö†Ô∏è Inspection not found on server (404). Attempting to create new record...');
                            const tId = currentInspectionData.taskId || (currentInspectionData.task ? currentInspectionData.task.id : taskId);
                            if (tId) {
                                response = await apiCall(`/tasks/${tId}/inspections`, 'POST', {
                                    inspectionJson: inspectionJson
                                });
                            } else {
                                throw err;
                            }
                        } else {
                            throw err;
                        }
                    }

                    if (response.success) {
                        // Crucial: Update our local ID with server ID if it changed
                        if (currentInspectionData.id !== response.data.id) {
                            console.log(`üîÑ Updating local inspection ID from ${currentInspectionData.id} to ${response.data.id}`);
                            // Delete old ID from local DB to avoid orphans? (Optional cleanup)
                            try { await inspectionDB.deleteInspection(currentInspectionData.id); } catch (e) { }

                            currentInspectionData = response.data;
                            // Add new ID to local DB
                            await inspectionDB.saveInspection(currentInspectionData);

                            // Update URL without reload
                            const newUrl = new URL(window.location);
                            newUrl.searchParams.set('inspectionId', response.data.id);
                            window.history.pushState({}, '', newUrl);
                        } else {
                            currentInspectionData = response.data;
                        }

                        if (!isSilent) alert('Inspection draft synced to server!');
                        console.log('Inspection draft synced:', currentInspectionData);
                    } else {
                        throw new Error(response.message || 'Failed to sync draft.');
                    }
                } catch (error) {
                    console.error('Error syncing draft:', error);
                    alert('Draft saved locally. Failed to sync to server: ' + error.message);
                }
            } else {
                alert('You are offline. Draft saved locally.');
            }
        }



        // API Utility Function
        async function apiCall(endpoint, method = 'GET', body = null, options = {}) {
            const fetchOptions = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (authToken) {
                fetchOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (body) {
                fetchOptions.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, fetchOptions);

                if (response.status === 401) {
                    // Token expired or unauthorized
                    logout();
                    throw new Error('Unauthorized. Please login again.');
                }

                if (response.status === 204) {
                    return null;
                }

                let data;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // Start of fallback for non-JSON response (e.g. 404 HTML)
                    const text = await response.text();
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}...`);
                    }
                    data = { message: text };
                }

                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }

                return data;
            } catch (error) {
                if (!options.silent) {
                    console.error(`API Error [${endpoint}]:`, error);
                }
                throw error;
            }
        }



        function calculateQualityMetrics() {
            const major = inspections.filter(i => i.issueType === 'Major').length;
            const minor = inspections.filter(i => i.issueType === 'Minor').length;
            const cosmetic = inspections.filter(i => i.issueType === 'Cosmetic').length;

            // Deduction Model: Major: -5%, Minor: -2%, Cosmetic: -1%
            const majorHealth = Math.max(0, 100 - (major * 5));
            const minorHealth = Math.max(0, 100 - (minor * 2));
            const cosmeticHealth = Math.max(0, 100 - (cosmetic * 1));

            // Update Progress Bars
            const updateBar = (id, health, count) => {
                const el = document.getElementById(id);
                el.style.width = health + "%";
                el.textContent = `${health}% (${count} Issues)`;
                // Color adjust based on health
                if (health < 70) el.style.background = '#dc3545';
                else if (health < 90) el.style.background = '#ffc107';
                else el.style.background = '#28a745';
            };

            updateBar('majorBar', majorHealth, major);
            updateBar('minorBar', minorHealth, minor);
            updateBar('cosmeticBar', cosmeticHealth, cosmetic);

            const majorStatus = document.getElementById('majorStatus');
            if (major === 0) {
                majorStatus.textContent = "Excellent - No Major Issues";
                majorStatus.className = "quality-status status-good";
            } else if (majorHealth >= 90) {
                majorStatus.textContent = major + " Issue(s) - Acceptable";
                majorStatus.className = "quality-status status-warning";
            } else {
                majorStatus.textContent = major + " Issue(s) - Action Required";
                majorStatus.className = "quality-status status-bad";
            }

            const minorStatus = document.getElementById('minorStatus');
            if (minor === 0) {
                minorStatus.textContent = "Good - No Minor Issues";
                minorStatus.className = "quality-status status-good";
            } else if (minorHealth >= 85) {
                minorStatus.textContent = minor + " Issue(s) - Minor Attention";
                minorStatus.className = "quality-status status-warning";
            } else {
                minorStatus.textContent = minor + " Issue(s) - Maintenance Needed";
                minorStatus.className = "quality-status status-bad";
            }

            const cosmeticStatus = document.getElementById('cosmeticStatus');
            if (cosmetic === 0) {
                cosmeticStatus.textContent = "Pristine - No Cosmetic Issues";
                cosmeticStatus.className = "quality-status status-good";
            } else if (cosmeticHealth >= 90) {
                cosmeticStatus.textContent = cosmetic + " Issue(s) - Slight Scuffs";
                cosmeticStatus.className = "quality-status status-good";
            } else {
                cosmeticStatus.textContent = cosmetic + " Issue(s) - Finishing Work Needed";
                cosmeticStatus.className = "quality-status status-warning";
            }
        }

        function showRoomForm() {
            document.getElementById('roomFormContainer').classList.remove("hidden");
            addDimensionRow();
        }

        // Line 746 - addDoorDimension
        function addDoorDimension() {
            const container = document.getElementById('doorDimensionsContainer');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.innerHTML = `
        <input type="number" step="0.01" placeholder="Height (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <span style="font-weight: 600;">√ó</span>
        <input type="number" step="0.01" placeholder="Width (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
    `;
            container.appendChild(div);
        }

        // Line 763 - addWindowDimension
        function addWindowDimension() {
            const container = document.getElementById('windowDimensionsContainer');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.innerHTML = `
        <input type="number" step="0.01" placeholder="Height (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <span style="font-weight: 600;">√ó</span>
        <input type="number" step="0.01" placeholder="Width (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
    `;
            container.appendChild(div);
        }


        function addTileDimension() {
            const container = document.getElementById('tileDimensionsContainer');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.innerHTML = `
        <input type="number" step="0.01" placeholder="Length (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <span style="font-weight: 600;">√ó</span>
        <input type="number" step="0.01" placeholder="Width (ft)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
        <button type="button" onclick="this.parentElement.remove()" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
    `;
            container.appendChild(div);
        }

        function hideRoomForm() {
            document.getElementById('roomForm').reset();
            document.getElementById('dimensionsContainer').innerHTML = "";
            document.getElementById('doorDimensionsContainer').innerHTML = "";
            document.getElementById('windowDimensionsContainer').innerHTML = "";
            document.getElementById('tileDimensionsContainer').innerHTML = "";
            document.getElementById('roomFormContainer').classList.add("hidden");
        }

        function addDimensionRow() {
            const div = document.createElement("div");
            div.className = "dimension-row";
            div.innerHTML = `
                <input class="dim-length" placeholder="Length (ft)" type="number" step="0.01" required>
                <input class="dim-width" placeholder="Width (ft)" type="number" step="0.01" required>
                <input class="dim-area" placeholder="Area (sq ft)" type="number" step="0.01" readonly>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
            `;
            document.getElementById('dimensionsContainer').appendChild(div);

            div.querySelector(".dim-length").oninput =
                div.querySelector(".dim-width").oninput = () => {
                    const l = parseFloat(div.querySelector(".dim-length").value) || 0;
                    const w = parseFloat(div.querySelector(".dim-width").value) || 0;
                    div.querySelector(".dim-area").value = (l * w).toFixed(2);
                };
        }

        document.getElementById('roomForm').addEventListener("submit", e => {
            e.preventDefault();
            const dims = [];
            let total = 0;

            document.querySelectorAll("#dimensionsContainer .dimension-row").forEach(r => {
                const l = parseFloat(r.querySelector(".dim-length").value);
                const w = parseFloat(r.querySelector(".dim-width").value);
                const a = parseFloat((l * w).toFixed(2));
                total += a;
                dims.push({ length: l, width: w, area: a });
            });

            // Collect door dimensions
            const doorDimensions = [];
            document.querySelectorAll('#doorDimensionsContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    doorDimensions.push({
                        height: parseFloat(inputs[0].value),
                        width: parseFloat(inputs[1].value)
                    });
                }
            });

            // Collect window dimensions
            const windowDimensions = [];
            document.querySelectorAll('#windowDimensionsContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    windowDimensions.push({
                        height: parseFloat(inputs[0].value),
                        width: parseFloat(inputs[1].value)
                    });
                }
            });

            // Collect tile dimensions
            const tileDimensions = [];
            document.querySelectorAll('#tileDimensionsContainer > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    tileDimensions.push({
                        length: parseFloat(inputs[0].value),
                        width: parseFloat(inputs[1].value)
                    });
                }
            });

            const nameVal = document.getElementById('roomName').value.trim();
            const newRoom = {
                id: Date.now(),
                name: nameVal,
                dimensions: dims,
                totalArea: parseFloat(total.toFixed(2)),
                brands: {
                    switchboards: 'Select Brand',
                    lightFixtures: 'Select Brand',
                    fan: 'Select Brand',
                    ac: 'Select Brand',
                    windows: 'Select Brand'
                },
                materials: {
                    flooring: 'Select Option',
                    wallFinish: 'Select Option',
                    door: 'Select Option',
                    windows: 'Select Option',
                    railing: 'Select Option'
                },
                dimensionDetails: {
                    ceilingHeight: document.getElementById('roomCeilingHeight').value || '',
                    doorDimensions: doorDimensions,
                    windowDimensions: windowDimensions,
                    tileDimensions: tileDimensions
                }
            };

            rooms.push(newRoom);
            saveSessionState();
            updateRoomsList();
            updateBrandMaterialSections();
            hideRoomForm();
        });

        function deleteRoom(roomId) {
            if (confirm('Are you sure you want to delete this room?')) {
                const room = rooms.find(r => r.id === roomId);
                rooms = rooms.filter(r => r.id !== roomId);
                if (room) {
                    const roomNameTrimmed = room.name.trim();
                    inspections = inspections.filter(i => i.room.trim() !== roomNameTrimmed);
                }
                saveSessionState();
                updateRoomsList();
                updateInspectionsList();
                updateBrandMaterialSections();
                calculateQualityMetrics();
            }
        }

        function updateRoomsList() {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = rooms.map(r => `
                <div class="room-item">
                    <div class="room-item-header">
                        <h3>${r.name}</h3>
                        <button class="btn btn-danger btn-small" onclick="deleteRoom(${r.id})">Delete Room</button>
                    </div>
                    <div class="dimensions-grid">
                        ${r.dimensions.map((d, idx) => `
                            <div class="dimension-item">
                                <label>Dimension ${idx + 1}</label>
                                <div class="value">${d.length} √ó ${d.width} ft</div>
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">${d.area} sq ft</p>
                            </div>
                        `).join('')}
                        <div class="dimension-item total">
                            <label>Total Area</label>
                            <div class="value">${r.totalArea} sq ft</div>
                        </div>
                    </div>
                </div>
            `).join("");

            document.getElementById('totalRooms').innerText = rooms.length;
            const sum = rooms.reduce((a, b) => a + b.totalArea, 0);
            document.getElementById('totalArea').innerText = sum.toFixed(2) + " sq ft";
            document.getElementById('avgArea').innerText = rooms.length ? (sum / rooms.length).toFixed(2) + " sq ft" : "0";
        }

        function updateBrandMaterialSections() {
            const container = document.getElementById('roomBrandMaterialContainer');

            if (rooms.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Please add rooms first to configure brands and materials.</p>';
                return;
            }

            container.innerHTML = rooms.map(room => `
                <div class="room-specific-section">
                    <h4>${room.name}</h4>
                    
                    <h5 style="color: #473c39; margin: 20px 0 15px 0; font-size: 16px;">Brand Check</h5>
                    <div class="brand-grid">
                        <div class="brand-card">
                            <label>Switchboards</label>
                            <select onchange="updateRoomBrand(${room.id}, 'switchboards', this.value)">
                                <option ${room.brands.switchboards === 'Select Brand' ? 'selected' : ''}>Select Brand</option>
                                <option ${room.brands.switchboards === 'Crabtree' ? 'selected' : ''}>Crabtree</option>
                                <option ${room.brands.switchboards === 'Anchor' ? 'selected' : ''}>Anchor</option>
                                <option ${room.brands.switchboards === 'GM' ? 'selected' : ''}>GM</option>
                                <option ${room.brands.switchboards === 'Legrand' ? 'selected' : ''}>Legrand</option>
                            </select>
                        </div>

                        <div class="brand-card">
                            <label>Light Fixtures</label>
                            <select onchange="updateRoomBrand(${room.id}, 'lightFixtures', this.value)">
                                <option ${room.brands.lightFixtures === 'Select Brand' ? 'selected' : ''}>Select Brand</option>
                                <option ${room.brands.lightFixtures === 'GM' ? 'selected' : ''}>GM</option>
                                <option ${room.brands.lightFixtures === 'Philips' ? 'selected' : ''}>Philips</option>
                                <option ${room.brands.lightFixtures === 'Not Available' ? 'selected' : ''}>Not Available</option>
                            </select>
                        </div>

                        <div class="brand-card">
                            <label>Fan</label>
                            <select onchange="updateRoomBrand(${room.id}, 'fan', this.value)">
                                <option ${room.brands.fan === 'Select Brand' ? 'selected' : ''}>Select Brand</option>
                                <option ${room.brands.fan === 'Other Brand' ? 'selected' : ''}>Other Brand</option>
                                <option ${room.brands.fan === 'Crompton' ? 'selected' : ''}>Crompton</option>
                                <option ${room.brands.fan === 'Not Available' ? 'selected' : ''}>Not Available</option>
                            </select>
                        </div>

                        <div class="brand-card">
                            <label>AC</label>
                            <select onchange="updateRoomBrand(${room.id}, 'ac', this.value)">
                                <option ${room.brands.ac === 'Select Brand' ? 'selected' : ''}>Select Brand</option>
                                <option ${room.brands.ac === 'Blue Star' ? 'selected' : ''}>Blue Star</option>
                                <option ${room.brands.ac === 'LG' ? 'selected' : ''}>LG</option>
                                <option ${room.brands.ac === 'Daikin' ? 'selected' : ''}>Daikin</option>
                                <option ${room.brands.ac === 'Hitachi' ? 'selected' : ''}>Hitachi</option>
                                <option ${room.brands.ac === 'Not Available' ? 'selected' : ''}>Not Available</option>
                            </select>
                        </div>

                        <div class="brand-card">
                            <label>Windows</label>
                            <select onchange="updateRoomBrand(${room.id}, 'windows', this.value)">
                                <option ${room.brands.windows === 'Select Brand' ? 'selected' : ''}>Select Brand</option>
                                <option ${room.brands.windows === 'UPVC' ? 'selected' : ''}>UPVC</option>
                                <option ${room.brands.windows === 'Aluminium' ? 'selected' : ''}>Aluminium</option>
                                <option ${room.brands.windows === 'Not Available' ? 'selected' : ''}>Not Available</option>
                            </select>
                        </div>
                    </div>

                    <h5 style="color: #473c39; margin: 20px 0 15px 0; font-size: 16px;">Material Check</h5>
                    <div class="material-grid">
                        <div class="material-card">
                            <label>Flooring</label>
                            <select onchange="updateRoomMaterial(${room.id}, 'flooring', this.value)">
                                <option ${room.materials.flooring === 'Select Option' ? 'selected' : ''}>Select Option</option>
                                <option ${room.materials.flooring === 'Vitrified Tiles' ? 'selected' : ''}>Vitrified Tiles</option>
                                <option ${room.materials.flooring === 'Antiskid Tiles' ? 'selected' : ''}>Antiskid Tiles</option>
                                <option ${room.materials.flooring === 'Ceramic Tiles' ? 'selected' : ''}>Ceramic Tiles</option>
                                <option ${room.materials.flooring === 'Marble' ? 'selected' : ''}>Marble</option>
                            </select>
                        </div>

                        <div class="material-card">
                            <label>Wall Finish</label>
                            <select onchange="updateRoomMaterial(${room.id}, 'wallFinish', this.value)">
                                <option ${room.materials.wallFinish === 'Select Option' ? 'selected' : ''}>Select Option</option>
                                <option ${room.materials.wallFinish === 'Plastic Emulsion Paint' ? 'selected' : ''}>Plastic Emulsion Paint</option>
                                <option ${room.materials.wallFinish === 'Ceramic Tiles' ? 'selected' : ''}>Ceramic Tiles</option>
                                <option ${room.materials.wallFinish === 'Wallpaper' ? 'selected' : ''}>Wallpaper</option>
                                <option ${room.materials.wallFinish === 'NA' ? 'selected' : ''}>NA</option>
                            </select>
                        </div>

                        <div class="material-card">
                            <label>Door</label>
                            <select onchange="updateRoomMaterial(${room.id}, 'door', this.value)">
                                <option ${room.materials.door === 'Select Option' ? 'selected' : ''}>Select Option</option>
                                <option ${room.materials.door === 'Flush Door' ? 'selected' : ''}>Flush Door</option>
                                <option ${room.materials.door === 'Wooden Door' ? 'selected' : ''}>Wooden Door</option>
                                <option ${room.materials.door === 'UPVC Door' ? 'selected' : ''}>UPVC Door</option>
                                <option ${room.materials.door === 'NA' ? 'selected' : ''}>NA</option>
                            </select>
                        </div>

                        <div class="material-card">
                            <label>Windows</label>
                            <select onchange="updateRoomMaterial(${room.id}, 'windows', this.value)">
                                <option ${room.materials.windows === 'Select Option' ? 'selected' : ''}>Select Option</option>
                                <option ${room.materials.windows === 'UPVC' ? 'selected' : ''}>UPVC</option>
                                <option ${room.materials.windows === 'Aluminium' ? 'selected' : ''}>Aluminium</option>
                                <option ${room.materials.windows === 'Wooden' ? 'selected' : ''}>Wooden</option>
                                <option ${room.materials.windows === 'NA' ? 'selected' : ''}>NA</option>
                            </select>
                        </div>

                        <div class="material-card">
                            <label>Railing</label>
                            <select onchange="updateRoomMaterial(${room.id}, 'railing', this.value)">
                                <option ${room.materials.railing === 'Select Option' ? 'selected' : ''}>Select Option</option>
                                <option ${room.materials.railing === 'Mild Steel' ? 'selected' : ''}>Mild Steel</option>
                                <option ${room.materials.railing === 'Stainless Steel' ? 'selected' : ''}>Stainless Steel</option>
                                <option ${room.materials.railing === 'Glass' ? 'selected' : ''}>Glass</option>
                                <option ${room.materials.railing === 'NA' ? 'selected' : ''}>NA</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRoomBrand(roomId, brandType, value) {
            const room = rooms.find(r => r.id === roomId);
            if (room) {
                room.brands[brandType] = value;
                saveSessionState();
            }
        }

        function updateRoomMaterial(roomId, materialType, value) {
            const room = rooms.find(r => r.id === roomId);
            if (room) {
                room.materials[materialType] = value;
                saveSessionState();
            }
        }

        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('inspectionCategory');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            const categories = Object.keys(issueDatabase);
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        function showInspectionForm() {
            if (rooms.length === 0) {
                alert('Please add at least one room before creating an inspection.');
                switchTab('area');
                return;
            }
            document.getElementById('inspectionFormContainer').classList.remove("hidden");
            populateCategoryDropdown();
        }

        function hideInspectionForm() {
            document.getElementById('inspectionForm').reset();
            uploadedImages = [];
            selectedIssue = null;
            document.getElementById('imagePreview').innerHTML = "";
            document.getElementById('issueDropdown').classList.add('hidden');
            document.getElementById('inspectionFormContainer').classList.add("hidden");
            document.getElementById('issueType').disabled = false;
        }

        function updateIssueDropdown() {
            const category = document.getElementById('inspectionCategory').value;
            const issueInput = document.getElementById('issueDescription');
            const dropdown = document.getElementById('issueDropdown');

            // Reset issue input when category changes
            issueInput.value = '';
            selectedIssue = null;
            dropdown.classList.add('hidden');
        }

        function showIssueDropdown() {
            const category = document.getElementById('inspectionCategory').value;
            console.log('Trying to show dropdown for category:', category);

            if (!category) {
                alert('Please select a category first');
                document.getElementById('issueDescription').blur();
                return;
            }

            if (!issueDatabase[category]) {
                console.error('CRITICAL: Category not found in issueDatabase!', category, Object.keys(issueDatabase));
            }

            filterIssues();
        }

        function filterIssues() {
            const category = document.getElementById('inspectionCategory').value;
            const searchTerm = document.getElementById('issueDescription').value.toLowerCase();
            const dropdown = document.getElementById('issueDropdown');

            if (!category) {
                dropdown.classList.add('hidden');
                return;
            }

            const issues = issueDatabase[category] || [];
            const filteredIssues = issues.filter(issue =>
                issue.title.toLowerCase().includes(searchTerm)
            );

            if (filteredIssues.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No matching issues found</div>';
                dropdown.classList.remove('hidden');
                return;
            }

            console.log(`Found ${filteredIssues.length} issues for term "${searchTerm}"`);

            dropdown.innerHTML = filteredIssues.map(issue => {
                // Escape quotes for HTML attribute to prevent syntax errors
                const escapedTitle = issue.title.replace(/'/g, "\\'");
                return `
                <div class="issue-dropdown-item" onclick="selectIssue('${escapedTitle}', '${issue.type}')">
                    <div class="issue-title">
                        ${issue.title}
                        <span class="issue-type issue-type-${issue.type.toLowerCase()}">${issue.type}</span>
                    </div>
                </div>
            `}).join('');

            dropdown.classList.remove('hidden');
        }

        // Dedicated handler for input to debug "unable to type" issues
        function handleIssueInput() {
            try {
                selectedIssue = null;
                const typeSelect = document.getElementById('issueType');
                if (typeSelect) typeSelect.disabled = false;
                filterIssues();
            } catch (e) {
                console.error('Error handling issue input:', e);
            }
        }

        function selectIssue(title, type) {
            console.log('Selected issue:', title);
            document.getElementById('issueDescription').value = title;
            selectedIssue = { title, type };
            document.getElementById('issueDropdown').classList.add('hidden');
            const issueTypeSelect = document.getElementById('issueType');
            issueTypeSelect.value = type;
            issueTypeSelect.disabled = true; // Lock type for predefined issues
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const issueInput = document.getElementById('issueDescription');
            const dropdown = document.getElementById('issueDropdown');

            if (issueInput && dropdown && !issueInput.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function updateInspectionRoomSelect() {
            const select = document.getElementById('inspectionRoom');
            select.innerHTML = '<option value="">Choose a room...</option>' +
                rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
        }

        function previewImages(e) {
            uploadedImages = [];
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = "";

            [...e.target.files].forEach(f => {
                const r = new FileReader();
                r.onload = () => {
                    uploadedImages.push(r.result);
                    preview.innerHTML += `<img src="${r.result}" alt="Preview">`;
                };
                r.readAsDataURL(f);
            });
        }

        document.getElementById('inspectionForm').addEventListener("submit", e => {
            e.preventDefault();
            const roomId = parseInt(document.getElementById('inspectionRoom').value);
            const room = rooms.find(r => r.id === roomId);

            if (!room) {
                alert('Please select a valid room.');
                return;
            }

            const issueDescription = document.getElementById('issueDescription').value;
            if (!issueDescription) {
                alert('Please enter an issue description.');
                return;
            }

            const issueType = document.getElementById('issueType').value;

            inspections.push({
                id: Date.now(),
                room: room.name,
                category: document.getElementById('inspectionCategory').value,
                issueType: issueType,
                description: issueDescription,
                images: [...uploadedImages],
                employee: currentEmployee,
                date: new Date().toISOString()
            });

            saveSessionState();
            updateInspectionsList();
            calculateQualityMetrics();

            // --- MODIFIED FOR MULTIPLE ENTRIES ---
            // Clear only issue specific fields, keep Room and Category selected
            document.getElementById('issueDescription').value = '';
            document.getElementById('issueType').value = 'Major';
            document.getElementById('issueType').disabled = false;
            uploadedImages = [];
            document.getElementById('imagePreview').innerHTML = "";
            selectedIssue = null;

            console.log('Issue added. Modal remains open for more entries.');
            // hideInspectionForm(); // Don't close modal
            // --------------------------------------

            // toast-like notification instead of alert for better flow
            const toast = document.createElement('div');
            toast.textContent = 'Issue added successfully!';
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10001; animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        });

        function deleteInspection(inspectionId) {
            if (confirm('Are you sure you want to delete this inspection?')) {
                inspections = inspections.filter(i => i.id !== inspectionId);
                saveSessionState();
                updateInspectionsList();
                calculateQualityMetrics();
            }
        }

        function updateInspectionsList() {
            const list = document.getElementById('inspectionsList');

            if (inspections.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No inspections recorded yet. Click "Add Inspection" to get started.</p>';
                return;
            }

            list.innerHTML = inspections.map(i => `
                <div class="issue-item">
                    <div class="issue-item-content">
                        <div class="issue-details">
                            <div class="issue-item-header">
                                <h4>${i.room}</h4>
                                <span class="issue-badge badge-${i.issueType.toLowerCase()}">${i.issueType}</span>
                            </div>
                            <p><strong>Category:</strong> ${i.category}</p>
                            <p><strong>Description:</strong> ${i.description}</p>
                            <p><strong>Reported by:</strong> ${currentUser?.name || 'Unknown'} on ${new Date(i.date).toLocaleDateString()}</p>
                            ${i.images.length > 0 ? `
                                <div class="issue-images">
                                    ${i.images.map(img => `<img src="${img}" alt="Issue photo" onclick="window.open(this.src)">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="issue-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteInspection(${i.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join("");
        }

        // Function to submit the final inspection (renamed from submitInspection)
        async function submitFinalInspection() {
            // Validation checks
            if (!currentInspectionData || !currentInspectionData.id) {
                alert('Error: No active inspection to submit.');
                return;
            }

            if (rooms.length === 0) {
                alert('Please add at least one room before submitting the inspection.');
                return;
            }

            const confirmation = confirm('Are you sure you want to submit this inspection? It cannot be edited after submission.');
            if (!confirmation) {
                return;
            }

            // Collect data, including prompts for client/property/verifier if not from task

            // Step 1: Ensure we have the latest server data (specifically prefillJson)
            try {
                if (navigator.onLine) {
                    console.log('üîÑ Refreshing inspection data before submission...');
                    const refreshResp = await apiCall(`/inspections/${currentInspectionData.id}`);
                    if (refreshResp.success && refreshResp.data) {
                        currentInspectionData = refreshResp.data;
                        // Update IDB
                        try { await inspectionDB.saveInspection(currentInspectionData); } catch (e) { }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not refresh data, proceeding with local copy', e);
            }

            const inspectionJson = collectInspectionData(true);

            // Final sanity check before sending
            if (!inspectionJson.rooms || inspectionJson.rooms.length === 0) {
                alert('Critical Error: Inspection schema is missing. Cannot submit. Please contact support.');
                return;
            }

            console.log('Submitting final inspection...');

            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                            background: rgba(0,0,0,0.8); display: flex; 
                            align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
                        <h3>Submitting Inspection...</h3>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                // IMPORTANT: Use POST method for submission
                const response = await apiCall(`/inspections/${currentInspectionData.id}/submit`, 'POST', { inspectionJson: inspectionJson });

                loadingDiv.remove();

                if (response.success || response.message === 'Inspection submitted successfully') {
                    alert('‚úÖ Inspection submitted successfully!');
                    window.location.href = '/inspector-dashboard.html';
                } else {
                    throw new Error(response.message || 'Failed to submit inspection.');
                }
            } catch (error) {
                loadingDiv.remove();
                console.error('Inspection submission failed:', error);
                alert(`Failed to submit inspection: ${error.message}`);
            }
        }

        async function generatePDFReport() {
            if (!currentInspectionData || !currentInspectionData.id) {
                alert('No inspection selected.');
                return;
            }

            if (!navigator.onLine) {
                alert('You are offline. Cannot generate PDF report.');
                return;
            }

            // Remove prompts, use task data
            const clientName = currentTaskData?.clientName || 'Unknown Client';
            const propertyAddress = currentTaskData?.propertyAddress || 'Unknown Address';
            const verifierName = currentTaskData?.assignedTo?.name || currentUser?.name || 'Unknown Verifier';

            console.log('Generating PDF Report for:', clientName);

            // Show loading
            const loader = document.getElementById('pdfLoader');
            loader.classList.add('active');

            try {
                // Use correct endpoint and minimal payload
                const response = await fetch(`${API_BASE_URL}/pdf/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        inspectionId: currentInspectionData.id,
                        clientName: clientName,
                        clientAddress: propertyAddress,
                        verifierName: verifierName
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Inspection_Report_${currentInspectionData.inspectionNumber || 'Draft'}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    loader.classList.remove('active');
                    console.log('‚úÖ PDF generated and downloaded');
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'PDF generation failed');
                }
            } catch (error) {
                loader.classList.remove('active');
                console.error('‚ùå PDF Report failed:', error);
                alert(`‚ùå PDF Report generation failed: ${error.message}`);
            }
        }

        // --- Offline Sync Logic ---
        window.addEventListener('online', async () => {
            console.log('üåê Back online! Checking for pending submissions...');
            try {
                // 1. Sync Pending Submissions
                const inspections = await inspectionDB.getAllInspections();
                const pending = inspections.filter(i => i.syncStatus === 'PENDING_SUBMIT');

                if (pending.length > 0) {
                    console.log(`Found ${pending.length} pending submissions. Syncing...`);
                    const banner = document.createElement('div');
                    banner.innerHTML = `üîÑ Syncing ${pending.length} pending inspection(s)...`;
                    banner.style.cssText = `position: fixed; top: 50px; left: 0; right: 0; background: #17a2b8; color: white; padding: 10px; text-align: center; z-index: 10000;`;
                    document.body.appendChild(banner);

                    for (const inspection of pending) {
                        try {
                            const response = await apiCall(`/inspections/${inspection.id}/submit`, 'POST', {
                                inspectionJson: inspection.inspectionJson
                            });

                            if (response.success) {
                                delete inspection.syncStatus;
                                inspection.status = 'FINAL';
                                await inspectionDB.saveInspection(inspection);
                                console.log(`‚úÖ Synced inspection ${inspection.id}`);
                            }
                        } catch (err) {
                            console.error(`‚ùå Failed to sync inspection ${inspection.id}`, err);
                        }
                    }
                    banner.remove();
                    alert('Sync completed! All pending inspections have been submitted.');
                }
            } catch (e) {
                console.error('Error during sync check:', e);
            }
        });

    </script>
    <script>
        // ============================================ 
        // PWA Registration & Service Worker
        // ============================================ 

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('üÜï New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.error('‚ùå Service Worker registration failed:', err);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'üì± Install App';
            installBtn.className = 'btn';
            installBtn.style.cssText = `
        position: fixed; 
        bottom: 20px; 
        right: 20px; 
        z-index: 9999;
        animation: pulse 2s infinite;
    `;

            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });

            document.body.appendChild(installBtn);

            // Auto-hide after 15 seconds
            setTimeout(() => installBtn.remove(), 15000);
        }

        // Track successful installation
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            deferredPrompt = null;
        });

        // Online/Offline detection
        window.addEventListener('online', () => {
            console.log('‚úÖ Back online');
            const banner = document.createElement('div');
            banner.innerHTML = '‚úÖ Connection restored';
            banner.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; 
        background: #28a745; color: white; padding: 10px; 
        text-align: center; z-index: 10000;
    `;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 3000);

            // Sync pending data
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    return registration.sync.register('sync-inspections');
                });
            }
        });

        window.addEventListener('offline', () => {
            console.log('‚ö†Ô∏è You are offline');
            const banner = document.createElement('div');
            banner.innerHTML = '‚ö†Ô∏è You are offline - changes will sync when connected';
            banner.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; 
        background: #ffc107; color: #000; padding: 10px; 
        text-align: center; z-index: 10000;
    `;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 5000);
        });

        // Add CSS animation for install button
        const style = document.createElement('style');
        style.textContent = `
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
`;
        document.head.appendChild(style);
    </script>

    <script>
        let stream;
        let currentFacingMode = "environment"; // rear camera by default

        function openCamera() {
            startCamera(currentFacingMode);
        }

        function openGallery() {
            document.getElementById('galleryInput').click();
        }

        function startCamera(facingMode) {
            // Stop old stream if exists
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: { exact: facingMode } },
                audio: false
            })
                .then(s => {
                    stream = s;
                    const video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('captureBtn').style.display = 'inline-block';
                    document.getElementById('flipBtn').style.display = 'inline-block';
                    document.getElementById('closeCameraBtn').style.display = 'inline-block';

                })
                .catch(err => {
                    // fallback if exact facingMode fails
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(s => {
                            stream = s;
                            const video = document.getElementById('camera');
                            video.srcObject = stream;
                            video.style.display = 'block';
                            document.getElementById('captureBtn').style.display = 'inline-block';
                            document.getElementById('flipBtn').style.display = 'inline-block';
                            document.getElementById('closeCameraBtn').style.display = 'inline-block';
                        })
                        .catch(e => {
                            alert("Camera not available");
                            console.error(e);
                        });
                });
        }

        function flipCamera() {
            currentFacingMode =
                currentFacingMode === "environment" ? "user" : "environment";

            startCamera(currentFacingMode);
        }


        function capturePhoto() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.9);

            uploadedImages.push(imageData);
            renderPreviews();

            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            stream = null;

            video.srcObject = null;
            video.style.display = 'none';

            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('closeCameraBtn').style.display = 'none';
            document.getElementById('flipBtn').style.display = 'none'; // ‚úÖ FIX
        }


        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            const video = document.getElementById('camera');
            video.srcObject = null;
            video.style.display = 'none';

            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('closeCameraBtn').style.display = 'none';
            document.getElementById('flipBtn').style.display = 'none'; // ‚úÖ FIX
        }


        function previewImages(event) {
            const files = Array.from(event.target.files);
            let loaded = 0;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function () {
                    uploadedImages.push(reader.result);
                    loaded++;

                    // ‚úÖ render ONLY ONCE after all files are read
                    if (loaded === files.length) {
                        renderPreviews();
                    }
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }


        function renderPreviews() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.style.width = '100%';
                wrapper.style.height = '150px';


                const image = document.createElement('img');
                image.src = img;
                image.style.position = 'absolute';
                image.style.top = '0';
                image.style.left = '0';

                const removeBtn = document.createElement('button');
                removeBtn.textContent = '‚úñ';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '5px';
                removeBtn.style.right = '5px';
                removeBtn.style.zIndex = '5';
                removeBtn.style.lineHeight = '20px';
                removeBtn.style.background = '#dc3545';
                removeBtn.style.color = '#fff';
                removeBtn.style.border = 'none';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '24px';
                removeBtn.style.height = '24px';
                removeBtn.style.cursor = 'pointer';

                removeBtn.onclick = () => {
                    uploadedImages.splice(index, 1);
                    renderPreviews();
                };

                wrapper.appendChild(image);
                wrapper.appendChild(removeBtn);
                preview.appendChild(wrapper);
            });
        }
    </script>
</body>

</html>